name: Build Executables

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.12']
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Create virtual environment
        run: |
          python -m venv .venv
      
      - name: Install dependencies
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            PYTHON_EXE=".venv/Scripts/python.exe"
            PIP_EXE=".venv/Scripts/pip.exe"
          else
            PYTHON_EXE=".venv/bin/python"
            PIP_EXE=".venv/bin/pip"
          fi
          
          # Install pdfminer.six separately (uv may have issues with the dot in package name)
          $PIP_EXE install "pdfminer.six>=20221105,<2025.0" || true
          
          # Install other dependencies using uv, fallback to pip
          if command -v uv &> /dev/null; then
            uv pip install --python $PYTHON_EXE -r requirements.txt || $PIP_EXE install -r requirements.txt
            uv pip install --python $PYTHON_EXE pyinstaller || $PIP_EXE install pyinstaller
          else
            $PIP_EXE install -r requirements.txt
            $PIP_EXE install pyinstaller
          fi
      
      - name: Run tests
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            PYTHON_EXE=".venv/Scripts/python.exe"
            export QT_QPA_PLATFORM=offscreen
          else
            PYTHON_EXE=".venv/bin/python"
            export QT_QPA_PLATFORM=offscreen
          fi
          
          $PYTHON_EXE -m pytest tests/ -v --tb=short || true
        continue-on-error: true
      
      - name: Build executable
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            PYINSTALLER_EXE=".venv/Scripts/pyinstaller.exe"
          else
            PYINSTALLER_EXE=".venv/bin/pyinstaller"
          fi
          
          # Clean any previous builds completely to avoid symlink conflicts
          rm -rf build dist *.spec.bak || true
          
          $PYINSTALLER_EXE Prometheus.spec --clean --noconfirm
      
      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Prepare artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cd dist/Prometheus
          zip -r ../../Prometheus-macOS-${VERSION}.zip Prometheus.app
          cd ../..
          echo "artifact_name=Prometheus-macOS-${VERSION}.zip" >> $GITHUB_ENV
      
      - name: Prepare artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cd dist/Prometheus
          tar -czf ../../Prometheus-Linux-${VERSION}.tar.gz .
          cd ../..
          echo "artifact_name=Prometheus-Linux-${VERSION}.tar.gz" >> $GITHUB_ENV
      
      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cd dist/Prometheus
          # Use PowerShell for compression on Windows
          powershell -Command "Compress-Archive -Path * -DestinationPath ../../Prometheus-Windows-${VERSION}.zip -Force"
          cd ../..
          echo "artifact_name=Prometheus-Windows-${VERSION}.zip" >> $GITHUB_ENV
      
      - name: Upload macOS artifact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: Prometheus-macOS-${{ steps.get_version.outputs.version }}
          path: |
            dist/Prometheus/Prometheus.app
            Prometheus-macOS-*.zip
          retention-days: 30
      
      - name: Upload Linux artifact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: Prometheus-Linux-${{ steps.get_version.outputs.version }}
          path: |
            dist/Prometheus/Prometheus
            Prometheus-Linux-*.tar.gz
          retention-days: 30
      
      - name: Upload Windows artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: Prometheus-Windows-${{ steps.get_version.outputs.version }}
          path: |
            dist\Prometheus\Prometheus.exe
            Prometheus-Windows-*.zip
          retention-days: 30

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Prometheus Forensic Tool ${{ github.ref_name }}
            
            Executáveis para macOS, Linux e Windows.
            
            ### Downloads
            - **macOS**: Prometheus-macOS-*.zip
            - **Linux**: Prometheus-Linux-*.tar.gz
            - **Windows**: Prometheus-Windows-*.zip
            
            ### Instruções
            - macOS: Extraia o ZIP e execute `Prometheus.app`
            - Linux: Extraia o tarball e execute `./Prometheus`
            - Windows: Extraia o ZIP e execute `Prometheus.exe`
          files: |
            artifacts/**/*
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

