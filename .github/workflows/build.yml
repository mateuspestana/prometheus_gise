name: Build Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.12']
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Create virtual environment
        run: |
          python -m venv .venv
      
      - name: Install dependencies
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            PYTHON_EXE=".venv/Scripts/python.exe"
            PIP_EXE=".venv/Scripts/pip.exe"
          else
            PYTHON_EXE=".venv/bin/python"
            PIP_EXE=".venv/bin/pip"
          fi
          
          # pdfminer.six precisa ser separado
          $PIP_EXE install "pdfminer.six>=20221105,<2025.0" || true
          
          # instalações (uv → pip fallback)
          if command -v uv &> /dev/null; then
            uv pip install --python $PYTHON_EXE -r requirements.txt || $PIP_EXE install -r requirements.txt
            uv pip install --python $PYTHON_EXE pyinstaller || $PIP_EXE install pyinstaller
          else
            $PIP_EXE install -r requirements.txt
            $PIP_EXE install pyinstaller
          fi
      
      - name: Run tests
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            PYTHON_EXE=".venv/Scripts/python.exe"
          else
            PYTHON_EXE=".venv/bin/python"
          fi
          
          export QT_QPA_PLATFORM=offscreen
          $PYTHON_EXE -m pytest tests/ -v --tb=short || true
        continue-on-error: true
      
      - name: Build executable
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            PYINSTALLER_EXE=".venv/Scripts/pyinstaller.exe"
          else
            PYINSTALLER_EXE=".venv/bin/pyinstaller"
          fi
          
          rm -rf build dist *.spec.bak || true
          $PYINSTALLER_EXE Prometheus.spec --clean --noconfirm
      
      - name: Get version
        id: get_version
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Prepare artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cd dist/Prometheus
          tar -czf ../../Prometheus-Linux-${VERSION}.tar.gz .
          cd ../..
          echo "artifact_file=Prometheus-Linux-${VERSION}.tar.gz" >> $GITHUB_ENV
      
      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          Compress-Archive -Path dist/Prometheus/* -DestinationPath "Prometheus-Windows-$version.zip" -Force
          echo "artifact_file=Prometheus-Windows-$version.zip" >> $env:GITHUB_ENV
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Prometheus-${{ runner.os }}-${{ steps.get_version.outputs.version }}
          path: ${{ env.artifact_file }}
          retention-days: 30


  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create GitHub Release and upload binaries
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Prometheus Forensic Tool ${{ github.ref_name }}"
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          body: |
            ## Prometheus Forensic Tool – versão ${{ github.ref_name }}

            Release automático gerado via GitHub Actions.

            ### Executáveis incluídos:
            - **Linux:** arquivo `.tar.gz`
            - **Windows:** arquivo `.zip`

            Extraia o arquivo correspondente ao seu sistema e execute normalmente.
          
          files: artifacts/**/*

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}